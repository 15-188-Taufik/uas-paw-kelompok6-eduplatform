<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grading Dashboard - {{ assignment.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .grade-input { width: 80px; }
        .feedback-input { width: 100%; height: 60px; font-size: 0.9em; }
        .status-badge { font-size: 0.8em; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Grading: {{ assignment.title }}</h4>
            <small>Course ID: {{ assignment.course_id }}</small>
        </div>
        <div class="card-body">
            
            {% if submissions %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 20%">Mahasiswa</th>
                            <th style="width: 15%">Waktu Submit</th>
                            <th style="width: 15%">File / Jawaban</th>
                            <th style="width: 10%">Nilai (0-100)</th>
                            <th style="width: 30%">Feedback</th>
                            <th style="width: 10%">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sub in submissions %}
                        <tr id="row-{{ sub.id }}">
                            <td>
                                <strong>{{ sub.student.name }}</strong><br>
                                <small class="text-muted">{{ sub.student.email }}</small>
                            </td>

                            <td>
                                {{ sub.submitted_at.strftime('%d %b %Y, %H:%M') }}
                            </td>

                            <td>
                                {% if sub.submission_file_url %}
                                    <a href="{{ sub.submission_file_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        ðŸ“„ Buka File
                                    </a>
                                {% else %}
                                    <span class="text-muted">Text Only</span>
                                {% endif %}
                                
                                {% if sub.submission_text %}
                                    <button type="button" class="btn btn-sm btn-link" onclick="alert('{{ sub.submission_text|replace("'", "\\'") }}')">
                                        Lihat Text
                                    </button>
                                {% endif %}
                            </td>

                            <td>
                                <input type="number" 
                                       class="form-control grade-input" 
                                       id="grade-{{ sub.id }}" 
                                       value="{{ sub.grade if sub.grade is not none else '' }}" 
                                       step="0.01" min="0" max="100">
                            </td>

                            <td>
                                <textarea class="form-control feedback-input" 
                                          id="feedback-{{ sub.id }}" 
                                          placeholder="Tulis feedback...">{{ sub.feedback if sub.feedback else '' }}</textarea>
                            </td>

                            <td>
                                <button onclick="saveGrade({{ sub.id }})" class="btn btn-success btn-sm w-100" id="btn-{{ sub.id }}">
                                    ðŸ’¾ Simpan
                                </button>
                                <div id="msg-{{ sub.id }}" class="text-success small mt-1" style="display:none;">Tersimpan!</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="alert alert-info text-center">
                    Belum ada mahasiswa yang mengumpulkan tugas ini.
                </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
async function saveGrade(submissionId) {
    const gradeInput = document.getElementById(`grade-${submissionId}`);
    const feedbackInput = document.getElementById(`feedback-${submissionId}`);
    const btn = document.getElementById(`btn-${submissionId}`);
    const msg = document.getElementById(`msg-${submissionId}`);

    const gradeVal = parseFloat(gradeInput.value);
    const feedbackVal = feedbackInput.value;

    if (isNaN(gradeVal)) {
        alert("Harap masukkan nilai angka yang valid!");
        return;
    }

    // Ubah tombol jadi loading
    const originalText = btn.innerText;
    btn.innerText = "â³ ...";
    btn.disabled = true;

    try {
        // Panggil API yang sudah kita buat di views/grading.py
        const response = await fetch(`/api/submissions/${submissionId}/grade`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                grade: gradeVal,
                feedback: feedbackVal
            })
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.detail || "Gagal menyimpan");
        }

        // Sukses
        msg.style.display = 'block';
        setTimeout(() => { msg.style.display = 'none'; }, 2000);
        
        // Visual feedback (hijau sebentar)
        gradeInput.classList.add('is-valid');
        setTimeout(() => gradeInput.classList.remove('is-valid'), 2000);

    } catch (error) {
        alert("Error: " + error.message);
    } finally {
        // Kembalikan tombol
        btn.innerText = originalText;
        btn.disabled = false;
    }
}
</script>

</body>
</html>